# Text_similarity_note
Homework for massive data processing

#### 1、算法流程

- 导入语料库，按篇将文本分开，并按篇章分别统计各个词语的词频。在统计词频时，按照已分好的词性来排除停用词。
- 针对每篇文章，根据词频计算TF和IDF值，并根据TFIDF指标提取该文章的关键词。
- 按每篇文章的关键词两两计算文章之间的相似性。

#### 2、具体实现

##### 2.1 读取文件及预处理

<img src="C:\Users\12812\AppData\Roaming\Typora\typora-user-images\image-20211029170026901.png" alt="image-20211029170026901" style="zoom:80%;" />

首先按行读取文章，并按照空行分割篇章、按空格分割词语。并排除连词、副词、量词等词性的词汇，将剩余词语统计词频。由于使用的向量空间模型不关注词语之间的顺序，故用字典（Dictionary）储存词频信息。

##### 2.2 TF/IDF计算公式

<img src="C:\Users\12812\AppData\Roaming\Typora\typora-user-images\image-20211029181643485.png" alt="image-20211029181643485" style="zoom:80%;" />

TF计算方式为某词在文章中出现的频数除以总词数，IDF为语料库总篇章数除以包含某词的文章数。为防止分母为0，故加1。

##### 2.3 获取文章关键词

<img src="C:\Users\12812\AppData\Roaming\Typora\typora-user-images\image-20211029181949870.png" alt="image-20211029181949870" style="zoom:80%;" />

按照TF*IDF的方式（参考jieba分词库的关键词提取算法），既考虑某词在文章中出现的次数（代表性），同时考虑在多个文章中出现的次数（区分度），按顺序提取出20个关键词。

##### 2.4 cosine相似度计算公式

<img src="C:\Users\12812\AppData\Roaming\Typora\typora-user-images\image-20211029182506570.png" alt="image-20211029182506570" style="zoom:80%;" />

将两篇文章的全部关键词作为全空间，按照多维向量cosine计算公式计算两个文章的相似度。

##### 2.5 文本相似度计算

<img src="C:\Users\12812\AppData\Roaming\Typora\typora-user-images\image-20211029182548927.png" alt="image-20211029182548927" style="zoom:80%;" />

### 3、性能提升

由第2部分可以看到，2.3获取文章关键词和2.5文本相似度计算两步占用时间较长，获取关键词用了107s，总用时153s，考虑可以从这两步入手提升效率。

获取关键词和计算相似度在篇章之间都是互相独立的，猜想可以通过多进程的方式并行计算以提速。

##### 改写获取关键词部分：

在使用Python multiprocessing库时，最好用与机器cpu核数相等的进程数，由cpu_count()给出。同时由于需要多进程共同维护一个包含所有关键词的列表，而进程间并不共享变量，故需要用Manager()来提供此支持。同时还要注意，所有的此前计算好的变量也需要通过参数形式传入计算关键词的函数，否则将会无法运行（最坑的是多进程碰到无法运行的部分会直接开始下一个任务而不报错，最终导致程序正常结束而无法产出结果）。故需要改写获取关键词函数。

此外，使用多进程时要注意程序是否为IO密集型，因为多进程IO时需要花费大量的时间进行进程间的通信、数据复制及发送，所以需要保证函数参数的size越小越好。因此在改写关键词函数时，我考虑将上一步获取的所有文章（passages）分为多个batch，分别传入不同的进程进行计算。如果不分batch而是将文章一个一个进行计算，所需时间将非常长（远超base程序）。同时，在最初统计词频时增加了一个统计全部篇章词语的字典，使得计算idf时能传入更小的参数。


##### 计算相似度部分：

使用同样的方式进行改写，但是注意到需要计算两两间的相似度，无法避免传入一个包含所有文章关键词的列表，故最终表现还不如基线水平。

可以看到使用并行计算后计算关键词速度提升非常高，而计算相似度则没有速度提升。故最终版本中只修改了获取关键词部分。



设备信息：6核R5-5600H 16G内存 SSD

